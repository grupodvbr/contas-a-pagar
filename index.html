<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Couvert e Extras - Multiempresas</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    header {
      background: white; padding: 10px 20px; display: flex; align-items: center; border-bottom: 1px solid #ccc;
    }
    header img { height: 50px; margin-right: 20px; }
    header h1 { font-size: 1.5em; margin: 0; }
    .container { padding: 20px; }
    input, select, button {
      padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px;
    }
    button { background: #2c3e50; color: white; cursor: pointer; }
    button:hover { background: #34495e; }
    table {
      width: 100%; border-collapse: collapse; background: white; margin-top: 20px;
    }
    th, td {
      padding: 8px; border: 1px solid #ddd; font-size: 13px; text-align: left;
    }
    .pago { background: #c8f7c5; }
    .pendente { background: #f7c5c5; }
    .lancado { background: #fdf4c5; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .filters > div { flex: 1 1 180px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
<style>
  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5em;
    color: #333;
    z-index: 9999;
    display: none;
  }
</style>
</head>
<body>
  <div id="loading-overlay">
  <div style="text-align: center">
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" style="width: 100px; margin-bottom: 10px;">
    <div id="loading-message">Carregando dados...</div>
  </div>
</div>

  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo">
    <h1>Painel de Couvert e Extras - Multiempresas</h1>
  </header>

  <div class="container">
    <h3>Filtros</h3>
    <div class="filters">
      <div>
        <label>Empresa:</label>
        <select id="filtroEmpresa">
          <option value="TODAS">TODAS</option>
          <option value="MERCATTO DELÍCIA">MERCATTO DELÍCIA</option>
          <option value="M.KIDS">M.KIDS</option>
          <option value="VILLA GOURMET">VILLA GOURMET</option>
          <option value="PADARIA DELÍCIA">PADARIA DELÍCIA</option>
          <option value="DELÍCIA GOURMET">DELÍCIA GOURMET</option>
        </select>
      </div>
      <div>
        <label>Status:</label>
        <select id="filtroStatus">
  <option value="TODOS">TODOS</option>
  <option value="PENDENTE">PENDENTE</option>
  <option value="LANÇADO" selected>LANÇADO</option>
  <option value="PAGO">PAGO</option>
</select>
      </div>
      <div>
        <label>Profissional:</label>
        <input type="text" id="filtroProfissional">
      </div>
      <div>
        <label>Pix:</label>
        <input type="text" id="filtroPix">
      </div>
      <div>
        <label>Data Início:</label>
        <input type="date" id="filtroDataInicio">
      </div>
      <div>
        <label>Data Fim:</label>
        <input type="date" id="filtroDataFim">
      </div>
      <div>
        <label>Valor Mínimo:</label>
        <input type="number" id="filtroValorMin" step="0.01">
      </div>
      <div>
        <label>Valor Máximo:</label>
        <input type="number" id="filtroValorMax" step="0.01">
      </div>
      <div style="align-self: end">
        <button onclick="aplicarFiltros()">Aplicar Filtros</button>
      </div>
    </div>

    <button onclick="liquidarEmMassa()">Liquidar em Massa</button>

    <table id="tabela">
      <thead>
        <tr>
          <th>Empresa</th><th>Data</th><th>Profissional</th><th>Função</th><th>Pix</th><th>Titular</th><th>Tempo</th>
          <th>Valor Acordado</th><th>Bonificação</th><th>Desconto</th><th>Valor Final</th>
          <th>Data Pagamento</th><th>CPF</th><th>Status</th><th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const urls = [
  { url: 'https://script.google.com/macros/s/AKfycbyF43AWfkx0KmtSyYvR6hSz9mqe5iSV0E2rQFpzjKBOvidHPKpMaJSlbtnlG9U9D_2Z/exec', empresa: 'MERCATTO DELÍCIA' },
  { url: '', empresa: 'M.KIDS' },
  { url: '', empresa: 'VILLA GOURMET' },
  { url: '', empresa: 'PADARIA DELÍCIA' },
  { url: 'https://script.google.com/macros/s/AKfycbzPSkWtXyxuCc_AFUGnKz_QiDdQlEN_zsUeQ74J90aRXcBbb7KBm7X1rsG1JmF1iZLN/exec', empresa: 'DELÍCIA GOURMET' }
];

const urlMap = {
  'MERCATTO DELÍCIA': 'https://script.google.com/macros/s/AKfycbyF43AWfkx0KmtSyYvR6hSz9mqe5iSV0E2rQFpzjKBOvidHPKpMaJSlbtnlG9U9D_2Z/exec',
  'M.KIDS': '',
  'VILLA GOURMET': '',
  'PADARIA DELÍCIA': '',
  'DELÍCIA GOURMET': 'https://script.google.com/macros/s/AKfycbzPSkWtXyxuCc_AFUGnKz_QiDdQlEN_zsUeQ74J90aRXcBbb7KBm7X1rsG1JmF1iZLN/exec'
};

let todosDados = [];

async function carregarTodosOsDados() {
  const tabela = document.querySelector('#tabela tbody');
  tabela.innerHTML = '';
  todosDados = [];

  for (const config of urls) {
    if (!config.url) continue;
    try {
      const res = await fetch(`${config.url}?acao=ler`);
      const dados = await res.json();
      dados.forEach(item => item.empresa = config.empresa);
      todosDados.push(...dados);
    } catch (e) {
      console.warn('Erro ao carregar dados de', config.empresa);
    }
  }
  aplicarFiltros();
}

function aplicarFiltros() {
  const overlay = document.getElementById('loading-overlay');
  const msg = document.getElementById('loading-message');
  msg.textContent = 'Carregando dados...';
  overlay.style.display = 'flex';
  document.getElementById('loading-overlay').style.display = 'flex';
  const tbody = document.querySelector('#tabela tbody');
  tbody.innerHTML = '';
  setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 300);

  const emp = document.getElementById('filtroEmpresa').value;
  const stat = document.getElementById('filtroStatus').value;
  const prof = document.getElementById('filtroProfissional').value.trim().toLowerCase();
  const pix = document.getElementById('filtroPix').value.trim().toLowerCase();
  const dataIni = document.getElementById('filtroDataInicio').value;
  const dataFim = document.getElementById('filtroDataFim').value;
  const vMin = parseFloat(document.getElementById('filtroValorMin').value);
  const vMax = parseFloat(document.getElementById('filtroValorMax').value);

  const filtrados = todosDados.filter(item => {
    const data = item.data ? item.data.split('T')[0] : '';
    const valor = parseFloat(item.valorFinal || 0);
    return (
      (emp === 'TODAS' || item.empresa === emp) &&
      (stat === 'TODOS' || item.status === stat) &&
      (prof === '' || (item.profissional || '').toLowerCase().includes(prof)) &&
      (pix === '' || (item.pix || '').toLowerCase().includes(pix)) &&
      (!dataIni || data >= dataIni) &&
      (!dataFim || data <= dataFim) &&
      (isNaN(vMin) || valor >= vMin) &&
      (isNaN(vMax) || valor <= vMax)
    );
  });

  filtrados.forEach(item => {
    const tr = document.createElement('tr');
    tr.className = (item.status || '').toLowerCase();
    tr.innerHTML = `
      <td>${item.empresa}</td>
      <td>${item.data?.split('T')[0] || ''}</td>
      <td>${item.profissional || ''}</td>
      <td>${item.funcao || ''}</td>
      <td>${item.pix || ''}</td>
      <td>${item.titular || ''}</td>
      <td>${item.tempo || ''}</td>
      <td>R$ ${(item.valorAcordado || 0).toFixed(2)}</td>
      <td>R$ ${(item.bonificacao || 0).toFixed(2)}</td>
      <td>R$ ${(item.desconto || 0).toFixed(2)}</td>
      <td>R$ ${(item.valorFinal || 0).toFixed(2)}</td>
      <td>${item.dataPagamento ? new Date(item.dataPagamento).toLocaleDateString('pt-BR') : ''}</td>
      <td>${item.cpf || ''}</td>
      <td><select onchange="atualizarStatusIndividual(this, '${item.empresa}', ${item.index})">
        <option value="PENDENTE" ${item.status === 'PENDENTE' ? 'selected' : ''}>PENDENTE</option>
        <option value="LANÇADO" ${item.status === 'LANÇADO' ? 'selected' : ''}>LANÇADO</option>
        <option value="PAGO" ${item.status === 'PAGO' ? 'selected' : ''}>PAGO</option>
      </select></td>
      <td><div class="actions"><button onclick="alert('Função de edição/exclusão não implementada neste painel.')">Editar</button></div></td>
    `;
    const selectStatus = tr.querySelector('select');
    if (selectStatus) selectStatus.setAttribute('data-original', item.status);
    tbody.appendChild(tr);
  });
}

function liquidarEmMassa() {
  const visiveis = document.querySelectorAll('#tabela tbody tr');
  if (visiveis.length === 0) return alert('Nenhum registro para liquidar com os filtros aplicados.');

  if (!confirm(`Deseja marcar ${visiveis.length} registros como PAGO?`)) return;

  visiveis.forEach(tr => tr.classList.add('pago'));
  alert('Registros marcados como PAGO (apenas visualmente). Envie para API se desejar persistência.');
}

function atualizarStatusIndividual(select, empresa, index) {
  const novoStatus = select.value;
  const valorAnterior = select.getAttribute('data-original');

  // Se estiver mudando para PENDENTE, exigir senha
  if (novoStatus === 'PENDENTE' && valorAnterior !== 'PENDENTE') {
    const senha = prompt('Digite a senha para alterar para PENDENTE:');
    if (senha !== '848663') {
      alert('Senha incorreta. Ação cancelada.');
      select.value = valorAnterior;
      return;
    }
  }
  const url = urlMap[empresa];
  if (!url) return alert(`URL da empresa "${empresa}" não encontrada.`);

  fetch(`${url}?acao=atualizarStatus`, {
    method: 'POST',
    body: JSON.stringify({ index, status: novoStatus })
  })
  .then(res => {
    if (!res.ok) throw new Error('Erro na requisição');
    alert(`Status atualizado para ${novoStatus}`);
  })
  .catch(err => {
    alert('Erro ao atualizar status');
    console.error(err);
  });
}

window.addEventListener('load', carregarTodosOsDados);
</script>
</body>
</html>
